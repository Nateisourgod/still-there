<script type="module">
import * as THREE from "https://unpkg.com/three@0.152.2/build/three.module.js";
import { PointerLockControls } from "https://unpkg.com/three@0.152.2/examples/jsm/controls/PointerLockControls.js";

let scene, camera, renderer, controls;
let monster, flashlight;
let dead = false;

init();
animate();

function init() {
scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);

camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 100);

renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

controls = new PointerLockControls(camera, document.body);

const overlay = document.getElementById("overlay");
overlay.onclick = () => controls.lock();

controls.addEventListener("lock", () => overlay.style.display = "none");
controls.addEventListener("unlock", () => overlay.style.display = "flex");

scene.add(controls.getObject());

scene.add(new THREE.AmbientLight(0x202020));

flashlight = new THREE.SpotLight(0xffffff, 2, 15, Math.PI / 6, 0.5);
camera.add(flashlight);
camera.add(flashlight.target);
flashlight.target.position.set(0, 0, -1);

const room = new THREE.Mesh(
new THREE.BoxGeometry(10, 4, 10),
new THREE.MeshStandardMaterial({ color: 0x222222, side: THREE.BackSide })
);
room.position.y = 2;
scene.add(room);

monster = new THREE.Mesh(
new THREE.CylinderGeometry(0.4, 0.6, 3, 8),
new THREE.MeshStandardMaterial({ color: 0x050505 })
);
monster.position.set(0, 1.5, -4);
scene.add(monster);

const keys = {};
addEventListener("keydown", e => keys[e.code] = true);
addEventListener("keyup", e => keys[e.code] = false);

addEventListener("keydown", e => {
if (e.code === "KeyF") flashlight.visible = !flashlight.visible;
});

setInterval(() => {
if (!controls.isLocked || dead) return;
const s = 0.05;
if (keys.KeyW) controls.moveForward(s);
if (keys.KeyS) controls.moveForward(-s);
if (keys.KeyA) controls.moveRight(-s);
if (keys.KeyD) controls.moveRight(s);
}, 16);

addEventListener("resize", () => {
camera.aspect = innerWidth / innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(innerWidth, innerHeight);
});
}

function animate() {
requestAnimationFrame(animate);
if (!dead) updateMonster();
renderer.render(scene, camera);
}

function updateMonster() {
const camDir = new THREE.Vector3();
camera.getWorldDirection(camDir);

const toMonster = monster.position.clone().sub(camera.position).normalize();
const looking = camDir.dot(toMonster) > 0.95;

if (!looking) monster.position.lerp(camera.position, 0.002);
else monster.lookAt(camera.position);

if (monster.position.distanceTo(camera.position) < 0.8) die();
}

function die() {
dead = true;
const overlay = document.getElementById("overlay");
overlay.innerHTML = "It was right there.<br><br>Refresh to try again.";
overlay.style.display = "flex";
controls.unlock();
}
</script>
